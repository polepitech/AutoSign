// signer.js
import fetch from 'node-fetch';
import { getEdSquareSessionData } from './login.js';
import 'dotenv/config'; // Si tu veux utiliser .env
import qs from 'querystring'


const signatureRaw = decodeURIComponent(
    'data%3Aimage%2Fpng%3Bbase64%2CiVBORw0KGgoAAAANSUhEUgAAASwAAACWCAYAAABkW7XSAAAAAXNSR0IArs4c6QAADzJJREFUeF7tnc%2BxLTcRh%2BUdSxcJGCKw9yyACAgBnAFEAKxYAhEAEbi8ZAXs2GEiADJwBuY173a5n2jNqGc0p6WZ71S98vU9%2BvtJ87utVkvzUeEDAQhAYBECHy3STpoJAQhAoCBYTAIIQGAZAgjWMkNFQyEAAQSLOQABCCxDAMFaZqhoKAQggGAxByAAgWUIIFjLDBUNhQAEECzmAAQgsAwBBGuZoaKhEIAAgsUcgAAEliGAYC0zVDQUAhBAsJgDEIDAMgQQrGWGioZCAAIIFnMAAhBYhgCCtcxQ0VAIQADBYg5AAAKjCfzorcBflVK%2BKaX8upTy1xGVIFgjKFIGBJ5LQMXpl28I9P8tEREsEa%2FTHwTrNEIKgMBjCOyJ01ellI9LKV%2BXUj57o%2FLjUdaVlIdgPWau0VEIhAmIQHmWky7v%2FmbE6ZN3wmStq6FCpS1HsMJjSAYI3JaAJ1AqTrKsk4%2F%2Bv6atl4Dqrxris6pJI1i3nXt0DAK7BERs5N8P3%2F5rLSf5uSU64o9Sy0sr%2BXcp5fu7NZ5MgGCdBEh2CCxGoLaMRJRq66nVJU%2BoJO0lyz%2BvEQjWYrON5kIgSMCzonoFSqtqCdWw3b%2FePiFYvaRIB4F1CKhIaYtlyRcVKckrQqXLRdv7lwuVVo5grTMJaSkEtgjUltQZ57eU9RensjShQrCY%2FBBYn4CKlDjARUzUkjq6Q9fa%2BVM%2F19Fyh5HGwhqGkoIg8BICVqT%2BVEqR3bmtHb2eRk0vVFhYPcNIGgjMQcAu9yRYUz5nRUrKWEaoEKw5JiKtgECLgOeTGnIeb0WhQrB4UCAwH4FWjNQo39FyFlU9RPiw5pu0tOg5BPRYi0abS89lyTdiuWcpLi9UWFjPeSjo6XwErraktMe3ESoEa75JTIvuTaAWjzNxUnuk7E5infZlx2j2Gnnke5aER6iRBwJ9BF5lSdnWSMCnd4ne0kKFhdU34UgFgSiBM4eLo3XZ9NOc9zvTib28WFh7hPgeAvsEskRKWvYIocLC2p%2BEpIDAFgFPpCS9LL1e8dm6QG9UvNYr%2BhGqAwsrhIvEDyeQaUkp%2Bq2dv1eJZdo0QLDS0FPxIgQ8gcg4DHy7EIUj449gHaFGnrsTUHGQfuqOW4ZIaf1yG0O985fVntSxR7BS8VP5ZAQywhBaCLCoHDII1mRPDM15OQFPpK44HtPbMYRqgxSC1TuNSHcnArP4pSxThKpjhiFYHZA6kniRxXvZ7PvdRp3G36vzyd%2FX17UIi1n8QF50%2Bixtm2rOIFjbw%2BGdptccR0SqVZtMzq3ytr6vxU4veNO6Rp%2F8n2oCdzRmhlCEVjO9oE%2BEiiXh5rS2QmFfDjlSkDqeq5ckkYch0z%2Fzkk42LqibSQgQqoMz4UkWlhUg%2Bdl7fdGWBaTf2Stqe9J7FpldDsr30p76d9I%2BrUt%2BvsKykzL19U93iI6eZZdP55r8AZQxVLby%2B%2FptNDMJ6UEZeV22OwqWt4yTftqH3iNsl1Zqhdhl1etGpa%2BmWoBtrogY23xqgcnvVhGw1hEZvb6lj%2BaYVC3H%2BS9KKT%2Bplv0I1QHmdxAsz5naY%2Fn0vFjSWj4H8E6RRflIY%2BySt6dxs1pfKwR2yttsvudARqh6Zl4jzYqC1SNQai1ZSym6E2f9DLe4S6haVh5ZFtvlzYlpdzjrLEs%2BXcbXEegqRj8rpfy06iVCdXjYv824kmC1XpstvdHJoD8PQPM%2FX4Muu9LfeDuiQxtl6PKvdyn5SgGfLWaqnodWiKStX5RSPjasEaqBk3cFwWo5Kq%2Fc7bLW1d3FyptOKmBbS8irRWsma0oY1bFStRD9sbKqZEn4udlMGfjYPreoFQTrH6WUz96G6OtSypeD3nbbGnVbn6S5%2BsGcffbpElycxjoOasmOvs7Es6auvPt8j70nmvUfSi9EQd7ILMtCPoMJrCZYXvetv2oPj%2BfHskGZv3tn0n9qClHr6g7O9z02Pd%2FX1u4IMfd8ktnLKK9N%2F6wE27P8%2BQPXM4tOpFlBsKR7Ym5%2FshMNfgLD6ax1JHodUzXSt3a6sScLkJ0v3f2SZY%2F8k08dM9b6f7GSxccjZWioifws5Uge%2BYMhaeqPjeDXfPI772evPbY8L77tP6WUH5RSvvv2z8P0VSlFQhRa172MtjhPDtX9sq8iWJa8dRDL7%2B8YkX6HmWZF3Aq4WCrWihWhEoGyy00r8N741mVrmr0jTme5qtjW5TzRz3mW5aH8KwpWq6NR4bKTXMqsI5Dldzb40C4L659bbbLR6nWarUBWzwJQq8Hma1kY9XlCW3fLGuydQL814tL7oL7Kge4FDUfnhcfBCpX9OXvp2jtmt0l3J8E6Myie47T3YTxT72p5a05b88fzA41kassfYWnLck%2BXoiL48rONTq8twZF9WW0epLUXwXqPHsHqm4LfmGStB9ZaU7oUHHFMxotu72v1%2B1TSFvWdaZyU7OaJUMlmi%2F3Y%2BaD5dMmKVRWhPjgtgvUeqH0QFTFs2g%2BxWCB2qeWJyRkLRMvWOLCeZV3rLKgugaUMDYxtiY7d%2BZP2i5UlS2D9nOnT4Ef3mcXxUPqCxcT88Hnwwhl0GWaj449aH7q8kzL3ou2t1aatbB27stae%2Bp68UAxJp8dpdOxrq3tECMczVWZgrxGs95ZC7XBHsL6dZDUfWUZpiIkspySQVwQjclbT829507oWp9466vIln3cO0lqG9typnQ%2BSl3CFgaJzpigEy%2FdfweX9rGq9Bl2%2Bi4h6r0BZX1evONXzv8cyqv1seiuFFTApF6vqjLpckJcHE8HyppU8uDZ8wS69ehzoEYGSsqMWmtfmWqi8Iz31zqKmqa1IrKoLxGZEkQhWKfXZwYjlMGIMZiqjJVQa4b3lK7JO7Vaf1MelIjWi71u3J2j5nkWlzvg6ah2rasSoXFQGglXKv6qL1p44YX%2F%2BdtzEXosiU651iNfu4rV28I76n3qnem1ReQ5%2FtahElOrvsap6SU%2BUDsH6%2F5CGJzERofpNKeU71Zz0hMpaKa%2B0oOq6PKHxlqlbVwTVV8U88Y%2FURDLU35QnPZy9fo9V7jLvH%2BUPU7asqXrZ1%2BOHumKJ1%2BqXJ5itEAXd5auX955Vxg7g0ZmUkO%2FpglUHjN6ZR0uo5DCyfGd9OjIVvaWehgeMcJL3TndPqDyneB2dboWoV%2Bx620S6JAJ3fkD3kHq7SnezrlpOdGGjFpX87F2XYh3jPTuDe7yj37eEqm5Ly6Gu9dVO%2BcwLAaMMSF8ReLJg1dbVnXYH5SH%2BQ%2BOtLeKfkvvFtkRK45KOxkKdedBGCZV1uKv4Zr9E4wwX8r4L%2FnuyYNWOV50QqwrXnjUlQlW%2FG0%2F7fPRIzeiHqOcQ%2Bp5FpctZotVHj84E5T1ZsOrdpno4VhGuPaGSfrUux8tY6nnT3nsjUs2%2FR6ikbHYAJxCWq5rwZMHSZcLeG6F1eTSTf2tLpKRf3s2YGQ7zvXnbu%2FzreYtRTwDpXnv4fnICTxcs65jteStyttUlu3nygs7aYmpNs1eGHUSm%2BkihknqfsIES4XvbtAjWh0Pb8z4%2B68C9cntfwwrk2hOxAr3XnnsTcxZ%2FVOuh6fVTqQ9qqz%2B9QaS3fYCf1jEEyx%2Fxeodpb17ockvFrE5vd9tUiDTuSZ3EujRtHXXZsqKufKnsXt97v%2Fd8ht5xGd293BPeWvh4F2DvSCycDsHaH7ytK1b2c1%2BTYtalntfbnuVfr0NdxZ0Dy9fMq%2BlLRbD6hyhqdfWXvJ9SX5Awy67efovfp9hb%2FkWEyisv26fYy4F0gwggWMdB2vcj7i3j7JJQlm%2Fij5LgTXGet5zofy6l%2FP3toT%2Feypyce8u%2F2uraO3zslYdY5Yxtaq0I1jX45QHbihL3whIkFEH%2BiS9mphCKCCFv%2BSf5VZDq73tEhwPLkRG4eVoE63UDvLWk1OMyGUdhRhHYWv55x2T2bknAqho1MjcqB8G6fjBbVodYU2Jh1O%2FEu75FY2vYc6rbgM69nT9pWau8PYEb2ytKm5IAgnXdsLSi0feuG76uRWNLblmM3muyeoTKc6r35hvbM0qblgCCNX5oxJkuh4ztdcPymvPf38CaUlre8k%2FvqKrvperZ2fSsqh7%2F1vjRo8SpCSBYY4bn7taUUtpyqut3kjZiGdWHlSN5x4wepSxDAME6N1S91w2fq2WO3C2nurRu7xXwXg9wqs8xrku1AsE6NlzysH3hLPskxkrO%2Ft3p03KCyxuf9X6tqFXU88abOzGkL4MIIFjHQNrbSsU%2F9XnwVe3Han19Lu%2BSQwnBkGDX6NJP0uOrev0Y3qpGBOvYcIqFINaFPLyrhyX0LtfEepSNhE%2FfxPlImIEVwKhVdmykyHUrAgjWrYbzdGc8C0gsSDlKNOICQF0KsgN4eqieWQCC9cxx77WqVKx40wzzZAoCCNYUwzBFIyR%2BTH1T0iAJcBXH%2BpWXFE7RcRqxDgEEa52xurqlshyUV4OJr0rEa%2BVzjVezovwkAghWEniqhQAE4gQQrDgzckAAAkkEEKwk8FQLAQjECSBYcWbkgAAEkgggWEngqRYCEIgTQLDizMgBAQgkEUCwksBTLQQgECeAYMWZkQMCEEgigGAlgadaCEAgTgDBijMjBwQgkEQAwUoCT7UQgECcAIIVZ0YOCEAgiQCClQSeaiEAgTgBBCvOjBwQgEASAQQrCTzVQgACcQIIVpwZOSAAgSQCCFYSeKqFAATiBBCsODNyQAACSQQQrCTwVAsBCMQJIFhxZuSAAASSCCBYSeCpFgIQiBNAsOLMyAEBCCQRQLCSwFMtBCAQJ4BgxZmRAwIQSCKAYCWBp1oIQCBOAMGKMyMHBCCQRADBSgJPtRCAQJwAghVnRg4IQCCJAIKVBJ5qIQCBOAEEK86MHBCAQBIBBCsJPNVCAAJxAghWnBk5IACBJAIIVhJ4qoUABOIEEKw4M3JAAAJJBBCsJPBUCwEIxAkgWHFm5IAABJIIIFhJ4KkWAhCIE0Cw4szIAQEIJBFAsJLAUy0EIBAngGDFmZEDAhBIIoBgJYGnWghAIE4AwYozIwcEIJBEAMFKAk%2B1EIBAnACCFWdGDghAIIkAgpUEnmohAIE4AQQrzowcEIBAEgEEKwk81UIAAnECCFacGTkgAIEkAghWEniqhQAE4gQQrDgzckAAAkkEEKwk8FQLAQjECSBYcWbkgAAEkgggWEngqRYCEIgTQLDizMgBAQgkEUCwksBTLQQgECfwXw4YJ8ThY5N5AAAAAElFTkSuQmCC'
  );

async function signerPresence() {
  console.log('ğŸ” RÃ©cupÃ©ration des infos de session...');
  const { csrfToken, cookieHeader,planningEventId } = await getEdSquareSessionData();
  
  console.log('ğŸ“¨ Envoi de la signature...');

  const formData = qs.stringify({
    'course_user_signature[signature_data]': signatureRaw,
    'course_user_signature[planning_event_id]': planningEventId,
  });
  
  const response = await fetch('https://app.edsquare.fr/apps/course_user_signatures', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-Csrf-Token': csrfToken,
      'Cookie': cookieHeader,
      'X-Requested-With': 'XMLHttpRequest',
      'Accept': '*/*',
      'Origin': 'https://app.edsquare.fr',
      'Referer': 'https://app.edsquare.fr/apps/classrooms',
    },
    body: formData
  });

  const text = await response.text();
  console.log(`âœ… RÃ©ponse EdSquare (${response.status}):\n`, text);
}

signerPresence().catch((err) => {
  console.error('âŒ Erreur pendant la signature :', err);
});
